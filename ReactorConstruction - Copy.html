<html>

<script src='https://d3js.org/d3.v5.min.js'></script>

<body onload='init()'>
	<style>
         body { font-family: Arial; }
    </style>
	
	<div id = "nav">
		<button onclick="window.location.href='./ElectricityGeneration.html';">Next</button>
	</div>
	
	<p>Reactor Construction</p>
	<button onclick="update(data, 'Commercial operation')">Constructed</button>
	<button onclick="update(data, 'Closure')">Decomissioned</button>
	<center><div id="operation_closure"></div></center>
	
	<script>
	var data
	var margin = 50;
	var height = 700;
	var width = 1000;
				
	var xdomain
	var xs
	
	async function init() {
		data = await d3.csv("./StartAndClosure.csv");
		data.forEach( function(d) {
			d['Commercial operation'] = d3.timeParse("%Y")(d['Commercial operation']);
			d['Closure'] = d3.timeParse("%Y")(d['Closure']);
		});
		console.log(data)
		
		xdomain = [d3.timeParse("%Y")(1940), d3.timeParse("%Y")(2020)]; 
		console.log(xdomain)
		xs = d3.scaleTime().domain(xdomain).range([0, width]);	
		update(data, 'Commercial operation');
	}
	
	function update(data, state){
		var label
		if (state == "Closure") {
			label = "Closed: ";
			color = "darkred";
			} 
		else {
			label = "Entered Operation: ";
			color = "steelblue"
		};
		d3.select("#operation_closure").html("");
		var svg = d3.select("#operation_closure")
			.append("svg")
				.attr("width", width + 2*margin)
				.attr("height", height + 2*margin)
			.append("g")
				.attr("transform","translate("+margin+","+margin+")");
				
		console.log(state)
		
		data = data.filter(function(d) {return d[state] != null;});

		var histogram = d3.histogram()
			.value(function(d) {return d[state];})
			.domain(xs.domain())
			.thresholds(xs.ticks(79));
		var bins = histogram(data);
		
		var y = d3.scaleLinear()
		  .range([height, 0]);
		y.domain([0, 11]); 
		
		svg.append("g")
			.call(d3.axisLeft(y))
			.selectAll("text")
			.style("font-size", 11)
			.style("fill", "black");

		
		xAxis = d3.axisBottom(xs).tickFormat(d3.timeFormat("%Y"));
		svg.append("g")
		  .attr("transform","translate(0,"+height+")")
		  .call(xAxis)
		  .selectAll("text")
			.style("font-size", 11)
			.style("fill", "black");
		
		
		var Tooltip = d3.select("#operation_closure")
			.append("div")
			.style("opacity", 0)
			.attr("class", "tooltip")
			.style("position", "absolute")
			.style("background-color", "white")
			.style("border", "solid")
			.style("border-width", "2px")
			.style("border-radius", "5px")
			.style("text-align", "left")
			.style("padding", "5px");
		
		var mouseover = function(d) {
			var html = "Year: " + d3.timeFormat("%Y")(d.x0) + "</br>" + label + d.length;	
			Tooltip
			  .style("opacity", 1)
			  .html(html)
			  .style("left", (d3.event.pageX + 15) + "px")
			  .style("top", (d3.event.pageY - 30) + "px");
			d3.select(this)
			  .style("stroke", "black")
			  .style("fill", "darkorange")
			  .style("opacity", 1);
		}
		
		var mouseout = function(d) {
			Tooltip
				.style("left", width + "px")
				.style("top", 0 + "px")
				.style("opacity", 0);
			d3.select(this)
			  .style("stroke", "white")
			  .style("opacity", .9)
			  .style("fill", color);
		}
			  
		svg.selectAll("rect")
			.data(bins)
			.enter()
			.append("rect")
				.attr("x", 1)
				.attr("transform", function(d) { return "translate(" + xs(d.x0) + "," + y(d.length) + ")"; })
				.attr("width", function(d) { return xs(d.x1) - xs(d.x0) -1 ; })
				.attr("height", function(d) { return height - y(d.length); })
				.style("fill", color)
				.style("opacity", .9)
				.style("stroke", "white")
			.on("mouseover", mouseover)
			.on("mouseout", mouseout);	
	}
	</script>
</body>

</html>